<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dragon Sprite-Sheet Maker (Three.js)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Three.js core + OBJ / MTL loaders (ESM) -->
<script type="importmap">
{
  "imports":{
    "three":"https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js",
    "OBJLoader":"https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/OBJLoader.js",
    "MTLLoader":"https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/loaders/MTLLoader.js"
  }
}
</script>

<style>
body{font-family:system-ui;background:#111;color:#eee;margin:0;padding:1rem;text-align:center}
canvas{display:none} /* off-screen render canvas */
#sheetPreview{max-width:100%;image-rendering:pixelated;border:1px solid #555;margin-top:1rem}
label{display:block;margin:.7rem auto}
button{margin-top:1rem;padding:.6rem 1.2rem;font-size:1rem}
</style>
</head>
<body>

<h2>Dragon Sprite-Sheet Maker</h2>

<label>OBJ file <input type="file" id="obj"></label>
<label>MTL file <input type="file" id="mtl"></label>
<label>Texture (JPEG/PNG) <input type="file" id="tex"></label>
<button id="go">Start</button>
<br>
<img id="sheetPreview" hidden>

<script type="module">
import * as THREE from 'three';
import { OBJLoader } from 'OBJLoader';
import { MTLLoader } from 'MTLLoader';

const SIZE = 256, COLS = 8, ROWS = 4, FRAMES = COLS*ROWS;
const btn     = document.getElementById('go');
const preview = document.getElementById('sheetPreview');

btn.onclick = async () => {
  btn.disabled = true; btn.textContent = 'Working…';

  /* --- 1. read local files into blobs/URLs --- */
  const objFile = document.getElementById('obj').files[0];
  const mtlFile = document.getElementById('mtl').files[0];
  const texFile = document.getElementById('tex').files[0];
  if(!objFile||!mtlFile||!texFile){ alert('Choose all three files'); btn.disabled=false; return; }

  const objURL = URL.createObjectURL(objFile);
  const mtlURL = URL.createObjectURL(mtlFile);
  const texURL = URL.createObjectURL(texFile);

  /* --- 2. set up scene --- */
  const scene = new THREE.Scene();
  const cam   = new THREE.PerspectiveCamera(30,1,0.01,100);
  const renderer = new THREE.WebGLRenderer({preserveDrawingBuffer:true,alpha:true});
  renderer.setSize(SIZE,SIZE);
  document.body.appendChild(renderer.domElement); // off-screen but needed

  /* lighting */
  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const key = new THREE.PointLight(0xffffff,0.8); key.position.set(5,5,5); scene.add(key);

  /* load material & obj */
  const mtl = await new MTLLoader().loadAsync(mtlURL);
  mtl.preload();
  const obj = await new OBJLoader().setMaterials(mtl).loadAsync(objURL);
  scene.add(obj);

  /* centre + scale */
  const box = new THREE.Box3().setFromObject(obj);
  const size = box.getSize(new THREE.Vector3()).length();
  const centre = box.getCenter(new THREE.Vector3());
  obj.position.sub(centre);                              // centre
  cam.position.set(0,0,size*1.1); cam.lookAt(0,0,0);     // tight crop

  /* canvases for frames and sprite sheet */
  const sheet = document.createElement('canvas');
  sheet.width = SIZE*COLS; sheet.height = SIZE*ROWS;
  const shCtx = sheet.getContext('2d');

  /* --- 3. render each angle --- */
  for(let i=0;i<FRAMES;i++){
    obj.rotation.y = -i*(2*Math.PI/FRAMES);
    renderer.render(scene,cam);

    const col=i%COLS, row=ROWS-1-Math.floor(i/COLS);
    shCtx.drawImage(renderer.domElement, col*SIZE, row*SIZE);
    await new Promise(r=>setTimeout(r,10)); // yield → keeps UI responsive
  }

  /* --- 4. make downloadable PNG --- */
  sheet.toBlob(blob=>{
    const url = URL.createObjectURL(blob);
    preview.src=url; preview.hidden=false;

    const a = document.createElement('a');
    a.href = url; a.download = 'dragon_head_sprite_32x256.png';
    a.textContent = 'Download PNG';
    document.body.appendChild(a);
  });

  btn.textContent = 'Done';
};
</script>
</body>
</html>