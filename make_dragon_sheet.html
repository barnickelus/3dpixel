<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<title>Sprite-Sheet Maker (yaw Ã— pitch)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script type="importmap"> â€¦ same three.js importmap â€¦ </script>
<style> â€¦ same CSS â€¦ </style>
</head><body>

<h2>Sprite-Sheet Maker</h2>

<!-- model + texture -->
<label>OBJ file  <input type="file" id="obj"></label>
<label>MTL file  <input type="file" id="mtl"></label>
<label>Texture   <input type="file" id="tex"></label>

<!-- grid -->
<label>Tile size (px)     <input type="number" id="tile"   value="256"  min="16"></label>
<label>Yaw frames         <input type="number" id="yaw"    value="32"   min="1"></label>
<label>Pitch frames       <input type="number" id="pitch"  value="5"    min="1"></label>    <!-- ðŸ”¸ -->
<label>Pitch range (Â°)    <input type="number" id="range"  value="60"   min="0" max="90"></label> <!-- ðŸ”¸ -->
<label>Columns (optional) <input type="number" id="cols"   placeholder="auto" min="1"></label>

<button id="go">Start</button>
<img id="sheetPreview" hidden>

<script type="module">
import * as THREE from 'three';
import { OBJLoader } from 'OBJLoader';
import { MTLLoader } from 'MTLLoader';

const $ = id=>document.getElementById(id);
function linkFrom(data,name,type='text/plain'){ â€¦ same helper â€¦ }

$('go').onclick = async () => {
  const [objFile,mtlFile,texFile]=['obj','mtl','tex'].map(id=>$ (id).files[0]);
  if(!objFile||!mtlFile||!texFile){alert('Need OBJ, MTL, texture');return;}

  /* read form values -------------------------------------------------- */
  const TILE = Math.max(16,+$('tile').value||256);
  const YAW  = Math.max(1 ,+$('yaw').value ||32);
  const PIT  = Math.max(1 ,+$('pitch').value||1);          // ðŸ”¸ may be 1 (no pitch)
  const RANGE= Math.max(0 ,Math.min(90,+$('range').value||60)); // ðŸ”¸ clamp 0-90
  let   COLS = +$('cols').value||0;
  if(!COLS||COLS<YAW) COLS = YAW;                         // one full yaw row
  const ROWS = PIT;
  const FR   = YAW * PIT;

  $('go').disabled=true; $('go').textContent='Workingâ€¦';

  /* Three.js boilerplate --------------------------------------------- */
  â€¦ identical scene / camera / lighting / OBJ load â€¦

  /* build pitch angle list ------------------------------------------- */
  // +RANGE (top) .. 0 .. -RANGE (bottom) evenly across PIT steps
  const pitchAngles=[];
  for(let p=0;p<PIT;p++){
     pitchAngles.push(THREE.MathUtils.degToRad(
        RANGE - (2*RANGE)*(p/(PIT-1||1)) ));              // PIT==1 â†’ 0Â°
  }

  /* sheet canvas ----------------------------------------------------- */
  const sheet=document.createElement('canvas');
  sheet.width = TILE * COLS;
  sheet.height= TILE * ROWS;
  const ctx = sheet.getContext('2d');

  /* render ----------------------------------------------------------- */
  let index=0;
  for(let pr=0; pr<PIT; pr++){              // row = pitch
    obj.rotation.x = pitchAngles[pr];
    for(let yr=0; yr<YAW; yr++){            // col = yaw
      obj.rotation.y = -yr*(2*Math.PI/YAW);
      cam.lookAt(0,0,0);                    // keep camera fixed
      cam.updateMatrixWorld();
      ren.render(scene,cam);

      const x=(yr%COLS)*TILE, y=pr*TILE;
      ctx.drawImage(ren.domElement,x,y);
      index++;
      await new Promise(r=>setTimeout(r,5));
    }
  }

  /* filenames -------------------------------------------------------- */
  const base=`dragon_sprite_${FR}f_${TILE}px_${YAW}yaw_${PIT}pit`;
  const pngName=base+'.png';

  /* PNG + links ------------------------------------------------------ */
  sheet.toBlob(b=>{
     $('sheetPreview').src=URL.createObjectURL(b); $('sheetPreview').hidden=false;
     linkFrom(b,pngName,'image/png');
  },'image/png');

  /* CSS + JSON atlas ------------------------------------------------- */
  let css=`.dragon{width:${TILE}px;height:${TILE}px;`+
          `background-image:url("${pngName}");background-repeat:no-repeat;`+
          `image-rendering:pixelated;}\n`;
  const atlas={meta:{image:pngName,size:{w:TILE*COLS,h:TILE*ROWS},
                     frameSize:{w:TILE,h:TILE},columns:COLS,rows:ROWS},
               frames:[]};

  index=0;
  for(let pr=0;pr<PIT;pr++){
    for(let yr=0;yr<YAW;yr++){
      const x=yr*TILE, y=pr*TILE;
      css+=`.dragon-f${index}{background-position:-${x}px -${y}px;}\n`;
      atlas.frames.push({name:`f${index}`,x,y,w:TILE,h:TILE});
      index++;
    }
  }
  linkFrom(css,  base+'.css');
  linkFrom(JSON.stringify(atlas,null,2), base+'.json');

  $('go').textContent='Done';
};
</script>
</body></html>