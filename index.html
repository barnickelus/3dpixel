<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesis Evolution — Star-Frenzy (160-frame Sprite Head)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html,body {
      margin:0; height:100%; background:#060616; overflow:hidden;
      font-family:"Inter",Arial,sans-serif;
    }
    canvas { width:100vw; height:100vh; display:block; touch-action:none; background:#000; }
    #hud, #compass, #effBar, #pauseBtn, #radarWrap, #zoomSlider { position:fixed; z-index:2 }
    #hud {
      top:14px; left:18px; color:#fff; font-size:15px;
      text-shadow:0 0 4px rgba(255,255,255,.3);
      background:rgba(20,20,32,0.45); border-radius:8px; padding:4px 10px;
      transition:background 0.2s;
    }
    #compass {
      top:60px; left:18px; color:#aaa; font-size:12px; line-height:12px; letter-spacing:1px;
      text-shadow:0 0 2px #000; background:rgba(20,20,32,0.18); border-radius:7px; padding:3px 7px;
    }
    #effBar {
      bottom:14px; left:18px; width:220px; height:18px; border-radius:9px;
      background:rgba(255,255,255,.12);
      overflow:hidden;
    }
    #effFill {
      width:100%; height:100%; border-radius:9px; background:#00e4b8;
      transition:width 0.3s cubic-bezier(.4,0,.2,1);
    }
    #pauseBtn {
      top:14px; right:18px; font-size:22px; color:#fff; cursor:pointer; user-select:none;
      background:rgba(34,34,40,0.7); border:none; border-radius:50%; width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
      transition:background 0.2s;
    }
    #pauseBtn:focus, #pauseBtn:hover {
      outline: 2px solid #0ef; background:rgba(34,34,40,0.95);
    }
    #radarWrap { top:48px; right:18px; width:70px; height:70px; display:none; }
    #radar { width:70px; height:70px; border:1px solid #555; border-radius:4px; background:rgba(0,0,0,.4);}
    #zoomSlider {
      top:130px; right:18px; width:70px; transform:rotate(-90deg);
      background:transparent;
    }
    /* Sprite head styling */
    :root {
      --tile:48px; --cols:32; --rows:5; --scale:4;
      --sheet:url("dragon_sprite_160f_48px.png");
    }
    #dragonHead {
      position:absolute; pointer-events:none;
      width:calc(var(--tile)*var(--scale));
      height:calc(var(--tile)*var(--scale));
      background-image:var(--sheet);
      background-repeat:no-repeat;
      background-size:calc(var(--tile)*var(--cols)*var(--scale))
                       calc(var(--tile)*var(--rows)*var(--scale));
      image-rendering:pixelated;
      transform-origin:center;
      will-change:background-position, width, height, left, top;
    }
    /* Pause overlay */
    #pauseOverlay {
      display:none; position:fixed; inset:0; z-index:10;
      background:rgba(0,0,0,0.45);
      justify-content:center; align-items:center;
      color:#fff; font-size:2.2em; font-weight:600;
      letter-spacing:1px; text-shadow:0 2px 8px #000;
      transition:opacity 0.2s;
    }
    #pauseOverlay.active { display:flex; opacity:1; }
    @media (max-width:600px) {
      #hud, #compass, #effBar { left:10px; font-size:13px; }
      #pauseBtn, #radarWrap, #zoomSlider { right:10px; }
      #effBar { width:150px; }
    }
  </style>
</head>
<body>
  <canvas id="game" aria-label="Game area" tabindex="0"></canvas>
  <div id="dragonHead" aria-hidden="true"></div>
  <!-- HUD -->
  <div id="hud" aria-live="polite" role="status">Mass: <span id="mass">10</span>&nbsp; Score: <span id="score">0</span>&nbsp; <span id="level">1</span></div>
  <div id="compass">N<br>E&nbsp;&nbsp;W<br>&nbsp;S</div>
  <div id="effBar" aria-label="Energy Bar"><div id="effFill"></div></div>
  <button id="pauseBtn" aria-pressed="false" aria-label="Pause Game">⏸︎</button>
  <div id="pauseOverlay">PAUSED</div>
  <div id="radarWrap"><canvas id="radar" width="70" height="70"></canvas></div>
  <input id="zoomSlider" type="range" min="0.5" max="2" step="0.01" value="1" aria-label="Zoom slider">
  <!-- Audio -->
  <audio id="backgroundMusic" src="background-music.mp3" loop preload="auto"></audio>
  <audio id="eatSnd"         src="eat.mp3"              preload="auto"></audio>
  <audio id="hurtSnd"        src="hurt.mp3"             preload="auto"></audio>
  <audio id="frenzySnd"      src="frenzy.mp3"           preload="auto"></audio>
<script>
/* ======= Sprite Head Helper (improved) ======= */
const HEAD = document.getElementById('dragonHead');
const TILE = 48, COLS = 32, ROWS = 5;
const SCALE = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--scale'), 10);
function updateHead(screenX, screenY, yawIdx, pitchIdx, zoom) {
  const size = TILE * SCALE * zoom;
  HEAD.style.width  = size + 'px';
  HEAD.style.height = size + 'px';
  HEAD.style.backgroundSize =
    (TILE * COLS * SCALE * zoom) + 'px ' +
    (TILE * ROWS * SCALE * zoom) + 'px';
  HEAD.style.backgroundPosition = 
    `${-yawIdx * size}px ${-pitchIdx * size}px`;
  HEAD.style.left = (screenX - size/2) + 'px';
  HEAD.style.top  = (screenY - size/2) + 'px';
}

/* ======= DOM Refs ======= */
const massEl      = document.getElementById('mass');
const scoreEl     = document.getElementById('score');
const levelEl     = document.getElementById('level');
const pauseBtn    = document.getElementById('pauseBtn');
const pauseOverlay= document.getElementById('pauseOverlay');
const radarCanvas = document.getElementById('radar');
const rctx        = radarCanvas.getContext('2d');
const effFill     = document.getElementById('effFill');
const bgMusic     = document.getElementById('backgroundMusic');
const eatSnd      = document.getElementById('eatSnd');
const hurtSnd     = document.getElementById('hurtSnd');
const frenzySnd   = document.getElementById('frenzySnd');
const zoomSlider  = document.getElementById('zoomSlider');
const radarWrap   = document.getElementById('radarWrap');

/* ======= Constants ======= */
const MASS_THRESH=600, TITAN_LEVEL=10, TITAN_MAX=6, TITAN_RESPAWN_MS=20000,
      SPECTRE_MAX=3, REAPER_MAX=3, C_RING_DIST=1600,
      SPECTRE_SPEED_MS=6000, SPECTRE_SPEED_MULT=1.25,
      RADAR_PADDING=4, ZOOM_EASE=0.25,
      MASS_SPEED_FACTOR=0.0012, EXTRA_TAIL_PCT=0.10, MAX_TAIL_DRAW=60,
      SAFE_PLAYER_MASS=70, BLINK_MS=300;

/* ======= Canvas Sizing ======= */
const canvas = document.getElementById('game'),
      ctx    = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled = false;
let W = innerWidth, H = innerHeight;
function resize() {
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
let resizeTimeout;
window.addEventListener('resize', ()=> {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(resize, 80);
});
resize();

/* ======= Game State ======= */
let sliderZoom = 1, zoom = 1;
zoomSlider.oninput = e => sliderZoom = parseFloat(e.target.value);

const rand=v=>Math.random()*v-v/2;
const dist=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1);
const lerp=(a,b,t)=>a+(b-a)*t;
const rgb=h=>({r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)});
const mix=(a,b,t)=>{const A=rgb(a),B=rgb(b);return`rgb(${Math.round(lerp(A.r,B.r,t))},${Math.round(lerp(A.g,B.g,t))},${Math.round(lerp(A.b,B.b,t))})`;};

const food=[], foes=[], titans=[], spectres=[], reapers=[], beacons=[], particles=[];
let player={x:0,y:0,r:15,mass:10,tail:[],baseSpeed:2.5,blink:0,speedBoost:0,heading:0},
    target={x:0,y:0,active:false},
    offset={x:0,y:0},
    pill  ={x:0,y:0,r:10,active:false,cd:0},
    frenzy=false, F_TIME=0, paused=false, radarActive=false,
    titanTimer=0, titanKill=0, spectreKill=0, level=1;
const STARS=120, stars=Array.from({length:STARS},()=>({x:rand(4000),y:rand(4000),s:Math.random()*1.5+0.5}));
const spawnFood =()=>{while(food.length<60)food.push({x:rand(1800),y:rand(1800),r:6});};
const spawnFoe  =()=>{foes.push({x:rand(2000),y:rand(2000),r:(player.mass>=MASS_THRESH?14:10)+Math.random()*20});};
const spawnTitan=()=>{const a=Math.random()*Math.PI*2,d=700+Math.random()*500;
  titans.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:25+Math.random()*35,hop:0});};
const spawnSpectre=()=>{const a=Math.random()*Math.PI*2,d=600+Math.random()*400;
  spectres.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:22+Math.random()*25,dash:0});};
const spawnReaper =()=>{const a=Math.random()*Math.PI*2,d=800+Math.random()*600;
  reapers.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:38+Math.random()*28,charge:0});};
const spawnPill  =()=>{pill={x:rand(1800),y:rand(1800),r:10,active:true,cd:0};};

spawnFood(); for(let i=0;i<12;i++)spawnFoe();
['N','S','E','W'].forEach(d=>{const P={N:[0,-C_RING_DIST],S:[0,C_RING_DIST],E:[C_RING_DIST,0],W:[-C_RING_DIST,0]}[d];
  beacons.push({x:P[0],y:P[1],r:18});});

/* ======= Events ======= */
function toWorld(e){return{x:(e.clientX-offset.x)/zoom,y:(e.clientY-offset.y)/zoom};}
canvas.onpointerdown = e=>{ if(paused) return;
  const p = toWorld(e); target = {x:p.x,y:p.y,active:true};
};
canvas.onpointermove = e=>{ if(target.active && !paused){
  const p = toWorld(e); target.x = p.x; target.y = p.y;
}};
canvas.onpointerup = ()=> target.active = false;

pauseBtn.onclick = () => {
  paused = !paused;
  pauseBtn.setAttribute('aria-pressed', paused ? 'true' : 'false');
  pauseBtn.textContent = paused ? '▶︎' : '⏸︎';
  pauseOverlay.classList.toggle('active', paused);
  if(bgMusic) paused ? bgMusic.pause() : bgMusic.play().catch(()=>{});
};

/* ======= Draw Helpers ======= */
function onScreen(x,y,r){ return !(x+r<player.x-W/(2*zoom)||x-r>player.x+W/(2*zoom)||y+r<player.y-H/(2*zoom)||y-r>player.y+H/(2*zoom)); }
function glow(x,y,r,c,a){
  // Enhanced: radial gradient for glow
  if(r*zoom<0.8||!onScreen(x,y,r))return;
  const grad = ctx.createRadialGradient(x, y, 0, x, y, r*1.7);
  grad.addColorStop(0, c);
  grad.addColorStop(1, "rgba(0,0,0,0)");
  ctx.globalAlpha=a;
  ctx.beginPath();
  ctx.arc(x, y, r*1.7, 0, Math.PI*2);
  ctx.fillStyle = grad;
  ctx.fill();
  ctx.globalAlpha=1;
}
function drawGrid(){ /* ... (your grid code) ... */ }
function burst(x,y,c){ /* ... (your burst/particle code) ... */ }

/* ======= Game Loop ======= */
let last = 0;
function loop(ts) {
  if(paused){ last=ts; return requestAnimationFrame(loop); }
  const dt = (ts - last) || 16; last = ts;

  // ... all your in-loop logic verbatim ...
  // Example: Animate starfield for parallax
  ctx.clearRect(0,0,W,H);
  for(const s of stars){
    let sx = ((s.x-player.x)*zoom + W/2) % W;
    let sy = ((s.y-player.y)*zoom + H/2) % H;
    ctx.globalAlpha = 0.32 + 0.28*s.s;
    ctx.beginPath();
    ctx.arc(sx,sy,s.s*zoom,0,2*Math.PI);
    ctx.fillStyle = "#fff";
    ctx.shadowBlur = 10*s.s*zoom;
    ctx.shadowColor = "#fff";
    ctx.fill();
    ctx.shadowBlur = 0;
  }
  ctx.globalAlpha = 1;

  // ...draw world, player, food, foes, particles, etc...

  // —— SPRITE-HEAD overlay —— 
  const yawIdx   = Math.round(((player.heading % (2*Math.PI)) + 2*Math.PI) / (2*Math.PI) * COLS) % COLS;
  const pitchIdx = Math.round(((-Math.sin(player.heading) + 1) / 2) * (ROWS - 1));
  updateHead(
    player.x * zoom + offset.x,
    player.y * zoom + offset.y,
    yawIdx,
    pitchIdx,
    zoom
  );

  // —— RADAR drawing —— 
  if(radarActive){
    rctx.clearRect(0,0,70,70);
    // ...rest of radar draw...
  }

  // —— HUD update (fixed) —— 
  massEl.textContent  = player.mass.toFixed(0);
  scoreEl.textContent = Math.floor(player.mass*10);
  levelEl.textContent = level;

  // —— Energy bar smooth fill —— 
  effFill.style.width = Math.max(0, Math.min(1, player.mass/100)) * 100 + '%';

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ======= iOS Audio Unlock ======= */
window.addEventListener('pointerdown',()=>{
  if(bgMusic && bgMusic.paused) bgMusic.play().catch(()=>{});
},{once:true});

// Accessibility: Pause on space or P
window.addEventListener('keydown',e=>{
  if(e.code==='Space' || e.key==='p' || e.key==='P'){
    pauseBtn.click();
    e.preventDefault();
  }
});

</script>
</body>
</html>
