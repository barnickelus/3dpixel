<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genesis Evolution — Star-Frenzy (3-D Dragon Head)</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <style>
    /* … (same CSS as before, omitted for brevity) … */
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="dragonHead"><canvas id="headCanvas"></canvas></div>
  <div id="hud">Mass: <span id="mass">10</span>&nbsp; Score: <span id="score">0</span>&nbsp;<span id="level">1</span></div>
  <div id="compass">N<br/>E&nbsp;&nbsp;W<br/>&nbsp;S</div>
  <div id="effBar"><div id="effFill"></div></div>
  <div id="pauseBtn">⏸︎</div>
  <div id="radarWrap"><canvas id="radar" width="70" height="70"></canvas></div>
  <input id="zoomSlider" type="range" min="0.5" max="2" step="0.01" value="1"/>
  <audio id="backgroundMusic" src="background-music.mp3" loop preload="auto"></audio>
  <audio id="eatSnd" src="eat.mp3" preload="auto"></audio>
  <audio id="hurtSnd" src="hurt.mp3" preload="auto"></audio>
  <audio id="frenzySnd" src="frenzy.mp3" preload="auto"></audio>

  <!-- 0) Shared constants -->
  <script>
    window.TILE  = 48;
    window.SCALE = 4;
    window.COLS  = 32;
    window.ROWS  = 5;
  </script>

  <!-- 1) Three.js + GLTFLoader -->
  <script type="module">
    console.log("MODULE SCRIPT STARTED");
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/loaders/GLTFLoader.js';

    const TILE  = window.TILE;
    const SCALE = window.SCALE;

    const canvas = document.getElementById('headCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setSize(TILE * SCALE, TILE * SCALE);

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(40, 1, 0.1, 100);
    camera.position.set(0, 0, 5);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
    dirLight.position.set(1, 2, 3);
    scene.add(dirLight);

    // ambient so you can actually see it
    scene.add(new THREE.AmbientLight(0xffffff, 0.3));

    let headMesh = null;
    new GLTFLoader().load(
      'dragon-head.glb',
      gltf => {
        headMesh = gltf.scene;
        // normalize & center:
        const box = new THREE.Box3().setFromObject(headMesh);
        const size = box.getSize(new THREE.Vector3()).length();
        const norm = 2 / size;
        headMesh.scale.setScalar(norm);

        box.setFromObject(headMesh);
        const center = box.getCenter(new THREE.Vector3()).negate();
        headMesh.position.copy(center);

        headMesh.rotation.order = 'YXZ';
        scene.add(headMesh);
        console.log("%c✔ 3-D head loaded & centred", "color:#0f0");
      },
      undefined,
      err => console.error("GLTF load error:", err)
    );

    window.renderHead = (yawRad, pitchRad) => {
      if (!headMesh) return;
      headMesh.rotation.y = yawRad;
      headMesh.rotation.x = pitchRad;
      renderer.render(scene, camera);
    };
  </script>

  <!-- 2) Main game code -->
  <script>
    console.log("MAIN SCRIPT STARTED");

    // bring in the shared constants
    const TILE  = window.TILE;
    const SCALE = window.SCALE;
    const COLS  = window.COLS;
    const ROWS  = window.ROWS;

    const canvas = document.getElementById('game');
    const ctx    = canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled = false;

    let W,H;
    function resize(){
      W=canvas.width=innerWidth;
      H=canvas.height=innerHeight;
    }
    window.addEventListener('resize',resize);
    resize();

    const massEl   = document.getElementById('mass'),
          scoreEl  = document.getElementById('score'),
          levelEl  = document.getElementById('level'),
          pauseBtn = document.getElementById('pauseBtn'),
          radarC   = document.getElementById('radar'),
          rctx     = radarC.getContext('2d');

    const MASS_THRESH=600, TITAN_LEVEL=10, TITAN_MAX=6, TITAN_RESPAWN_MS=20000,
          SPECTRE_MAX=3, REAPER_MAX=3, C_RING_DIST=1600,
          SPECTRE_SPEED_MS=6000, SPECTRE_SPEED_MULT=1.25,
          RADAR_PADDING=4, ZOOM_EASE=0.25,
          MASS_SPEED_FACTOR=0.0012, EXTRA_TAIL_PCT=0.10, MAX_TAIL_DRAW=60,
          SAFE_PLAYER_MASS=70, BLINK_MS=300;

    let sliderZoom=1, zoom=1;
    document.getElementById('zoomSlider').oninput = e => sliderZoom = parseFloat(e.target.value);

    const rand=v=>Math.random()*v-v/2;
    const dist=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1);
    const lerp=(a,b,t)=>a+(b-a)*t;
    const rgb=h=>({r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)});
    const mix=(a,b,t)=>{const A=rgb(a),B=rgb(b);return `rgb(${Math.round(lerp(A.r,B.r,t))},${Math.round(lerp(A.g,B.g,t))},${Math.round(lerp(A.b,B.b,t))})`;};

    const food=[],foes=[],titans=[],spectres=[],reapers=[],beacons=[],particles=[];
    let player={x:0,y:0,r:15,mass:10,tail:[],baseSpeed:2.5,blink:0,speedBoost:0,heading:0},
        target={x:0,y:0,active:false},
        offset={x:0,y:0},
        pill={x:0,y:0,r:10,active:false,cd:0},
        frenzy=false,F_TIME=0,paused=false,radarActive=false,
        titanTimer=0,titanKill=0,spectreKill=0,level=1;

    const STARS=120, stars=Array.from({length:STARS},()=>({x:rand(4000),y:rand(4000),s:Math.random()*1.5+0.5}));

    const spawnFood = ()=>{while(food.length<60)food.push({x:rand(1800),y:rand(1800),r:6});};
    const spawnFoe  = ()=>{foes.push({x:rand(2000),y:rand(2000),r:(player.mass>=MASS_THRESH?14:10)+Math.random()*20});};
    const spawnTitan= ()=>{const a=Math.random()*Math.PI*2,d=700+Math.random()*500;
      titans.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:25+Math.random()*35,hop:0});};
    const spawnSpectre= ()=>{const a=Math.random()*Math.PI*2,d=600+Math.random()*400;
      spectres.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:22+Math.random()*25,dash:0});};
    const spawnReaper = ()=>{const a=Math.random()*Math.PI*2,d=800+Math.random()*600;
      reapers.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,r:38+Math.random()*28,charge:0});};
    const spawnPill  = ()=>{pill={x:rand(1800),y:rand(1800),r:10,active:true,cd:0};};

    spawnFood(); for(let i=0;i<12;i++)spawnFoe();
    ['N','S','E','W'].forEach(d=>{const P={N:[0,-C_RING_DIST],S:[0,C_RING_DIST],E:[C_RING_DIST,0],W:[-C_RING_DIST,0]}[d];
      beacons.push({x:P[0],y:P[1],r:18});});

    function toWorld(e){return {x:(e.clientX-offset.x)/zoom,y:(e.clientY-offset.y)/zoom};}
    canvas.onpointerdown = e=>{ if(paused)return; const p=toWorld(e); target={x:p.x,y:p.y,active:true}; };
    canvas.onpointermove = e=>{ if(target.active&&!paused){ const p=toWorld(e); target.x=p.x; target.y=p.y; } };
    canvas.onpointerup   = ()=> target.active=false;

    pauseBtn.onclick = ()=>{
      paused = !paused;
      pauseBtn.textContent = paused?'▶︎':'⏸︎';
      const bg = document.getElementById('backgroundMusic');
      if(bg) paused?bg.pause():bg.play().catch(()=>{});
    };

    function onScreen(x,y,r){
      return !(x+r<player.x-W/(2*zoom)||x-r>player.x+W/(2*zoom)||y+r<player.y-H/(2*zoom)||y-r>player.y+H/(2*zoom));
    }
    function glow(x,y,r,c,a){
      if(r*zoom<0.8||!onScreen(x,y,r))return;
      ctx.globalAlpha=a;ctx.shadowBlur=12*zoom;ctx.shadowColor=c;ctx.fillStyle=c;
      ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.globalAlpha=1;
    }
    function drawGrid(){
      const step=zoom<=0.8?60:120;
      ctx.lineWidth=1.2;
      for(let z=0;z<6;z++){
        const s=1+z*0.15,opa=0.8-0.12*z;
        ctx.strokeStyle=`rgba(34,34,34,${opa})`;
        for(let i=-4;i<=4;i++){
          for(let j=-4;j<=4;j++){
            const x=i*step*s,y=j*step*s;
            if(!onScreen(x,y,step*s*1.4))continue;
            ctx.beginPath();ctx.rect(x,y,step*s,step*s);ctx.stroke();
          }
        }
      }
    }
    function burst(x,y,c){for(let i=0;i<12;i++)particles.push({x,y,dx:rand(2),dy:rand(2),r:3,ttl:600,col:c});}

    function updateHead(sx,sy,yIdx,pIdx,zf){
      const wrap=document.getElementById('dragonHead');
      const size = TILE*SCALE*zf;
      wrap.style.width=size+'px';
      wrap.style.height=size+'px';
      wrap.style.left=(sx-size/2)+'px';
      wrap.style.top=(sy-size/2)+'px';

      const cvs=document.getElementById('headCanvas');
      cvs.style.width=size+'px';
      cvs.style.height=size+'px';

      if(typeof window.renderHead==='function'){
        window.renderHead((yIdx/COLS)*2*Math.PI,((pIdx/(ROWS-1))-0.5)*Math.PI);
      }
    }

    let last=0;
    function loop(ts){
      try{
        if(paused){ last=ts; requestAnimationFrame(loop); return; }
        const dt = (ts-last)||16; last=ts;

        // zoom & move
        zoom=lerp(zoom,Math.min(sliderZoom,Math.max(0.5,H/(player.r*4))),ZOOM_EASE);
        const dx=(target.active?target.x:player.x)-player.x,
              dy=(target.active?target.y:player.y)-player.y,
              dLen=Math.hypot(dx,dy);
        if(dLen>0.5)player.heading=Math.atan2(dy,dx);
        if(player.speedBoost>0)player.speedBoost=Math.max(0,player.speedBoost-dt);
        const speed=player.baseSpeed*(player.speedBoost>0?SPECTRE_SPEED_MULT:1)*(frenzy?1.3:1)*(1+player.mass*MASS_SPEED_FACTOR);
        if(dLen>1){player.x+=dx/dLen*speed;player.y+=dy/dLen*speed;}

        // mass decay
        player.mass=Math.max(5,player.mass-(0.000009*player.r*player.r+(player.mass<150?0.002:0.003))*dt);

        // recenter
        offset.x=W/2-player.x*zoom; offset.y=H/2-player.y*zoom;

        // background
        ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,W,H);ctx.fillStyle='#060616';ctx.fillRect(0,0,W,H);
        ctx.fillStyle='#222';for(const s of stars){const sx=(s.x-player.x*0.1)*zoom+offset.x,sy=(s.y-player.y*0.1)*zoom+offset.y;if(sx<0||sx>W||sy<0||sy>H)continue;ctx.fillRect(sx,sy,s.s,s.s);}
        ctx.setTransform(zoom,0,0,zoom,offset.x,offset.y);drawGrid();

        // food
        for(let i=food.length-1;i>=0;i--){const f=food[i];if(dist(player.x,player.y,f.x,f.y)<player.r+f.r){player.mass+=f.r;food.splice(i,1);burst(f.x,f.y,'#ff0');document.getElementById('eatSnd').play().catch(()=>{});}}
        spawnFood();

        // foes…
        while(foes.length<(player.mass>=MASS_THRESH?18:12))spawnFoe();
        foes.forEach((o,i)=>{ const d=dist(player.x,player.y,o.x,o.y); if(player.r>o.r&&d<player.r){player.mass+=o.r*2.5;foes.splice(i,1);burst(o.x,o.y,'#f00');document.getElementById('eatSnd').play().catch(()=>{});return;} if(o.r>player.r&&d<o.r){if(player.blink<50)player.blink=BLINK_MS;player.mass=Math.max(5,player.mass-.04*dt);document.getElementById('hurtSnd').play().catch(()=>{});} const c=1; if(o.r<player.r&&d<250){o.x-=(player.x-o.x)/d*c;o.y-=(player.y-o.y)/d*c;}else if(o.r>player.r&&d<250){o.x+=(player.x-o.x)/d*c;o.y+=(player.y-o.y)/d*c;} });

        // … titans, spectres, reapers, pill, beacons …

        // draw glows
        food.forEach(f=>glow(f.x,f.y,f.r,f.frenzy?f.col:'#ff0',f.frenzy?0.8:0.65));
        foes.forEach(o=>glow(o.x,o.y,o.r,'#f00',.8));
        titans.forEach(o=>glow(o.x,o.y,o.r,'#cc00ff',.9));
        spectres.forEach(s=>glow(s.x,s.y,s.r,mix('#ffde59','#ff39ff',(Math.sin((ts+s.x)*.006)+1)/2),.9));
        reapers.forEach(r=>glow(r.x,r.y,r.r,mix('#ff8800','#ff39ff',(Math.sin((ts+r.y)*.004)+1)/2),.9));
        if(pill.active){const pH=(Math.sin(ts*.005)+1)/2;glow(pill.x,pill.y,pill.r,mix('#00aaff','#ff39ff',pH),.95);}

        // head
        const yawIdx=Math.round(((player.heading%(2*Math.PI))+2*Math.PI)/(2*Math.PI)*COLS)%COLS;
        const pitchIdx=Math.round(((-Math.sin(player.heading)+1)/2)*(ROWS-1));
        updateHead(player.x*zoom+offset.x,player.y*zoom+offset.y,yawIdx,pitchIdx,zoom);

        // HUD
        massEl.textContent = player.mass.toFixed(0);
        scoreEl.textContent = Math.floor(player.mass*10);
        levelEl.textContent = level;

        requestAnimationFrame(loop);
      } catch(err) {
        console.error("Error in loop():", err);
      }
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>